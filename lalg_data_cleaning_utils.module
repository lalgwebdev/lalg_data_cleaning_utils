<?php

//************************************************************
// Supports the VBO Action to delete all personal data
//  Drupal 8 version
//************************************************************

/*
//********************************************************************
// Adds Hook to tweak the Query generated by the Delete Personal Data View.
//********************************************************************

// Needed because standard Views does not allow variable logic within the HAVING clause,
// which is needed.

function lalg_data_cleaning_utils_views_query_alter(&$view, &$query) {
	//  Only relevant to the Delete Personal Data View
	if($view->name != 'delete_personal_data') { return; }
//dpm($view);
//dpm($query);

	// Views does not handle date expressions on HAVING clauses, so do it here.
	// Make as general and resilient as possible -
	// Can't make it work if put foreach on $query->having as well (??)
	if (!$query->having) { return; }
	
	foreach($query->having[1]['conditions'] as $filter) { 
		if (isset($filter['value']) && isset($filter['value'][':civicrm_event_start_date'])) {
			$startDate = new DateTime($filter['value'][':civicrm_event_start_date']);
			$fdate = date_format($startDate, 'Ymd');
			$filter['value'][':civicrm_event_start_date'] = $fdate;
		}
	}
	// Views does AND on all HAVING conditions.  We want OR.
	$query->having[1]['type'] = 'OR';		

}

 */
